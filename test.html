<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이미지 필터 앱</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            width: 100%;
        }
        .slider-container label {
            min-width: 100px;
        }
        canvas {
            max-width: 100%;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        #fileInput {
            display: none;
        }
        .upload-btn {
            background-color: #2196F3;
        }
        .save-btn {
            background-color: #ff9800;
        }
        .reset-btn {
            background-color: #f44336;
        }
        .filter-section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="controls">
            <input type="file" id="fileInput" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">이미지 업로드</button>
            <button class="save-btn" onclick="saveImage()">이미지 저장</button>
            <button class="reset-btn" onclick="resetImage()">원본으로 되돌리기</button>
        </div>

        <div class="filter-section">
            <h3>필터</h3>
            <div class="slider-container">
                <label for="grayscale">흑백: </label>
                <input type="range" id="grayscale" min="0" max="100" value="0" oninput="applyFilters()">
                <span id="grayscaleValue">0%</span>
            </div>

            <div class="slider-container">
                <label for="sepia">세피아: </label>
                <input type="range" id="sepia" min="0" max="100" value="0" oninput="applyFilters()">
                <span id="sepiaValue">0%</span>
            </div>
        </div>

        <div class="filter-section">
            <h3>조정</h3>
            <div class="slider-container">
                <label for="brightness">밝기: </label>
                <input type="range" id="brightness" min="-100" max="100" value="0" oninput="applyFilters()">
                <span id="brightnessValue">0</span>
            </div>

            <div class="slider-container">
                <label for="contrast">대비: </label>
                <input type="range" id="contrast" min="-100" max="100" value="0" oninput="applyFilters()">
                <span id="contrastValue">0</span>
            </div>
        </div>

        <canvas id="myCanvas"></canvas>
    </div>

    <script>
        class ImageFilter {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.image = null;
                this.originalImageData = null;
            }

            loadImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.image = new Image();
                        this.image.onload = () => {
                            this.canvas.width = this.image.width;
                            this.canvas.height = this.image.height;
                            this.ctx.drawImage(this.image, 0, 0);
                            this.originalImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                            resolve();
                        };
                        this.image.onerror = reject;
                        this.image.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            reset() {
                if (this.originalImageData) {
                    this.ctx.putImageData(this.originalImageData, 0, 0);
                }
            }

            grayscale(intensity = 100) {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                const factor = intensity / 100;

                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    data[i] = data[i] + (avg - data[i]) * factor;     // R
                    data[i + 1] = data[i + 1] + (avg - data[i + 1]) * factor; // G
                    data[i + 2] = data[i + 2] + (avg - data[i + 2]) * factor; // B
                }

                this.ctx.putImageData(imageData, 0, 0);
            }

            sepia(intensity = 100) {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                const factor = intensity / 100;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    const tr = Math.min(255, (r * (1 - factor)) + (((r * 0.393) + (g * 0.769) + (b * 0.189)) * factor));
                    const tg = Math.min(255, (g * (1 - factor)) + (((r * 0.349) + (g * 0.686) + (b * 0.168)) * factor));
                    const tb = Math.min(255, (b * (1 - factor)) + (((r * 0.272) + (g * 0.534) + (b * 0.131)) * factor));

                    data[i] = tr;
                    data[i + 1] = tg;
                    data[i + 2] = tb;
                }

                this.ctx.putImageData(imageData, 0, 0);
            }

            brightness(value) {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;

                for (let i = 0; i < data.length; i += 4) {
                    data[i] = Math.min(255, Math.max(0, data[i] + value));
                    data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + value));
                    data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + value));
                }

                this.ctx.putImageData(imageData, 0, 0);
            }

            contrast(value) {
                const factor = (259 * (value + 255)) / (255 * (259 - value));
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;

                for (let i = 0; i < data.length; i += 4) {
                    data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));
                    data[i + 1] = Math.min(255, Math.max(0, factor * (data[i + 1] - 128) + 128));
                    data[i + 2] = Math.min(255, Math.max(0, factor * (data[i + 2] - 128) + 128));
                }

                this.ctx.putImageData(imageData, 0, 0);
            }
        }

        // 전역 변수로 필터 인스턴스 생성
        const filter = new ImageFilter('myCanvas');

        // 파일 입력 이벤트 처리
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await filter.loadImage(file);
                applyFilters(); // 현재 슬라이더 값으로 필터 적용
            }
        });

        // 모든 필터 적용 함수
        function applyFilters() {
            if (!filter.image) return;
            
            filter.reset();

            const grayscaleValue = parseInt(document.getElementById('grayscale').value);
            const sepiaValue = parseInt(document.getElementById('sepia').value);
            const brightnessValue = parseInt(document.getElementById('brightness').value);
            const contrastValue = parseInt(document.getElementById('contrast').value);

            // 값 표시 업데이트
            document.getElementById('grayscaleValue').textContent = `${grayscaleValue}%`;
            document.getElementById('sepiaValue').textContent = `${sepiaValue}%`;
            document.getElementById('brightnessValue').textContent = brightnessValue;
            document.getElementById('contrastValue').textContent = contrastValue;

            // 필터 순서대로 적용
            if (grayscaleValue > 0) filter.grayscale(grayscaleValue);
            if (sepiaValue > 0) filter.sepia(sepiaValue);
            if (brightnessValue !== 0) filter.brightness(brightnessValue);
            if (contrastValue !== 0) filter.contrast(contrastValue);
        }

        // 이미지 초기화 함수
        function resetImage() {
            if (!filter.image) return;
            
            // 모든 슬라이더 초기화
            document.getElementById('grayscale').value = 0;
            document.getElementById('sepia').value = 0;
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 0;
            
            // 값 표시 초기화
            document.getElementById('grayscaleValue').textContent = '0%';
            document.getElementById('sepiaValue').textContent = '0%';
            document.getElementById('brightnessValue').textContent = '0';
            document.getElementById('contrastValue').textContent = '0';
            
            filter.reset();
        }

        // 이미지 저장 함수
        function saveImage() {
            if (!filter.image) return;
            
            const link = document.createElement('a');
            link.download = 'filtered-image.png';
            link.href = filter.canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>